#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Message Parser for Seha Sick Leave Bot
ÙˆØ­Ø¯Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ù„Ø¨ÙˆØª ØµØ­Ø© Ù„Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
"""

import re
from typing import Dict, Optional

class MessageParser:
    """ÙØ¦Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ù†Ø³Ù‚Ø© ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    
    def __init__(self):
        # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        self.patterns = {
            'patient_name_ar': [
                r'ğŸ‘¤\s*Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'ğŸ‘¤.*Ø¹Ø±Ø¨ÙŠ.*:\s*(.+)'
            ],
            'patient_name_en': [
                r'ğŸ‘¤\s*Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'ğŸ‘¤.*Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.*:\s*(.+)'
            ],
            'id_number': [
                r'ğŸ†”\s*Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©\s*:\s*(.+)',
                r'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©\s*:\s*(.+)',
                r'ğŸ†”.*:\s*(.+)'
            ],
            'nationality_ar': [
                r'ğŸŒ\s*Ø§Ù„Ø¬Ù†Ø³ÙŠØ©\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'ğŸŒ.*Ø¹Ø±Ø¨ÙŠ.*:\s*(.+)'
            ],
            'nationality_en': [
                r'ğŸŒ\s*Ø§Ù„Ø¬Ù†Ø³ÙŠØ©\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ù„Ø¬Ù†Ø³ÙŠØ©\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'ğŸŒ.*Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.*:\s*(.+)'
            ],
            'employer_ar': [
                r'ğŸ¢\s*Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'ğŸ¢.*Ø¹Ø±Ø¨ÙŠ.*:\s*(.+)'
            ],
            'employer_en': [
                r'ğŸ¢\s*Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'ğŸ¢.*Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.*:\s*(.+)'
            ],
            'doctor_name_ar': [
                r'ğŸ‘¨â€âš•ï¸\s*Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'ğŸ‘¨â€âš•ï¸.*Ø¹Ø±Ø¨ÙŠ.*:\s*(.+)'
            ],
            'doctor_name_en': [
                r'ğŸ‘¨â€âš•ï¸\s*Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'ğŸ‘¨â€âš•ï¸.*Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.*:\s*(.+)'
            ],
            'position_ar': [
                r'ğŸ’¼\s*Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'ğŸ’¼.*Ø¹Ø±Ø¨ÙŠ.*:\s*(.+)'
            ],
            'position_en': [
                r'ğŸ’¼\s*Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'ğŸ’¼.*Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.*:\s*(.+)'
            ],
            'admission_date_gregorian': [
                r'ğŸ“…\s*ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„\s*\(Ù…ÙŠÙ„Ø§Ø¯ÙŠ\)\s*:\s*(.+)',
                r'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„\s*\(Ù…ÙŠÙ„Ø§Ø¯ÙŠ\)\s*:\s*(.+)',
                r'ğŸ“….*Ø§Ù„Ø¯Ø®ÙˆÙ„.*Ù…ÙŠÙ„Ø§Ø¯ÙŠ.*:\s*(.+)'
            ],
            'discharge_date_gregorian': [
                r'ğŸ“…\s*ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬\s*\(Ù…ÙŠÙ„Ø§Ø¯ÙŠ\)\s*:\s*(.+)',
                r'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬\s*\(Ù…ÙŠÙ„Ø§Ø¯ÙŠ\)\s*:\s*(.+)',
                r'ğŸ“….*Ø§Ù„Ø®Ø±ÙˆØ¬.*Ù…ÙŠÙ„Ø§Ø¯ÙŠ.*:\s*(.+)'
            ],
            'hospital_name_ar': [
                r'ğŸ¥\s*Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©\s*\(Ø¹Ø±Ø¨ÙŠ\)\s*:\s*(.+)',
                r'ğŸ¥.*Ø¹Ø±Ø¨ÙŠ.*:\s*(.+)'
            ],
            'hospital_name_en': [
                r'ğŸ¥\s*Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©\s*\(Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ\)\s*:\s*(.+)',
                r'ğŸ¥.*Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.*:\s*(.+)'
            ],
            'time': [
                r'â°\s*Ø§Ù„ÙˆÙ‚Øª\s*:\s*(.+)',
                r'Ø§Ù„ÙˆÙ‚Øª\s*:\s*(.+)',
                r'â°.*:\s*(.+)'
            ]
        }
    
    def is_formatted_message(self, message: str) -> bool:
        """ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø³Ù‚Ø© Ø£Ù… Ù„Ø§"""
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        required_fields = ['patient_name_ar', 'id_number', 'admission_date_gregorian', 'discharge_date_gregorian']
        found_fields = 0
        
        for field in required_fields:
            if self.extract_field(message, field):
                found_fields += 1
        
        # Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª 3 Ø­Ù‚ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ ÙØ§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø³Ù‚Ø©
        return found_fields >= 3
    
    def extract_field(self, message: str, field_name: str) -> Optional[str]:
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø­Ù‚Ù„ Ù…Ø¹ÙŠÙ† Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©"""
        if field_name not in self.patterns:
            return None
        
        for pattern in self.patterns[field_name]:
            match = re.search(pattern, message, re.IGNORECASE | re.MULTILINE)
            if match:
                value = match.group(1).strip()
                # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª
                value = re.sub(r'[^\w\s\-/:.ØŒØ›]', '', value).strip()
                return value if value else None
        
        return None
    
    def parse_message(self, message: str) -> Dict[str, str]:
        """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø© ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        data = {}
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
        for field_name in self.patterns.keys():
            value = self.extract_field(message, field_name)
            if value:
                data[field_name] = value
        
        return data
    
    def validate_data(self, data: Dict[str, str]) -> Dict[str, str]:
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"""
        # Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        required_fields = {
            'patient_name_ar': 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'patient_name_en': 'Not Specified',
            'id_number': '0000000000',
            'nationality_ar': 'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©',
            'nationality_en': 'Saudi Arabia',
            'employer_ar': 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'employer_en': 'Not Specified',
            'doctor_name_ar': 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
            'doctor_name_en': 'Not Specified',
            'position_ar': 'Ø·Ø¨ÙŠØ¨ Ø¹Ø§Ù…',
            'position_en': 'General Practitioner',
            'admission_date_gregorian': '01-01-2025',
            'discharge_date_gregorian': '01-01-2025',
            'hospital_name_ar': 'Ù…Ø³ØªØ´ÙÙ‰ Ø¹Ø§Ù…',
            'hospital_name_en': 'General Hospital',
            'time': '12:00 PM'
        }
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        for field, default_value in required_fields.items():
            if field not in data or not data[field]:
                data[field] = default_value
        
        return data

# Ù…Ø«Ø§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
if __name__ == "__main__":
    parser = MessageParser()
    
    # Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
    test_message = """ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ (Ø¹Ø±Ø¨ÙŠ): Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ
ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ): Abdullah Mohammed Ali
ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©: 828287654
ğŸŒ Ø§Ù„Ø¬Ù†Ø³ÙŠØ© (Ø¹Ø±Ø¨ÙŠ): Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
ğŸŒ Ø§Ù„Ø¬Ù†Ø³ÙŠØ© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ): Saudi Arabia
ğŸ¢ Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ (Ø¹Ø±Ø¨ÙŠ): Ø·Ø§Ù„Ø¨ Ø¬Ø§Ù…Ø¹ÙŠ
ğŸ¢ Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ): University Student
ğŸ‘¨â€âš•ï¸ Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø¹Ø±Ø¨ÙŠ): Ø§Ù„Ù…Ù‚Ø¨Ù†ÙŠ
ğŸ‘¨â€âš•ï¸ Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ): Almakbany
ğŸ’¼ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ø¹Ø±Ø¨ÙŠ): Ø·Ø¨ÙŠØ¨ Ø¹Ø§Ù…
ğŸ’¼ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ): General
ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù…ÙŠÙ„Ø§Ø¯ÙŠ): 20-09-2025
ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù…ÙŠÙ„Ø§Ø¯ÙŠ): 21-09-2025
ğŸ¥ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© (Ø¹Ø±Ø¨ÙŠ): Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù„Ùƒ ÙÙŠØµÙ„ Ø§Ù„ØªØ®ØµØµÙŠ ÙˆÙ…Ø±ÙƒØ² Ø§Ù„Ø£Ø¨Ø­Ø§Ø«
ğŸ¥ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ): King Faisal Specialist Hospital and Research Centre
â° Ø§Ù„ÙˆÙ‚Øª: 10:20 AM"""
    
    # ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø³Ù‚Ø©
    print("Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø³Ù‚Ø©ØŸ", parser.is_formatted_message(test_message))
    
    # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    parsed_data = parser.parse_message(test_message)
    validated_data = parser.validate_data(parsed_data)
    
    print("\nØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:")
    for key, value in validated_data.items():
        print(f"{key}: {value}")

